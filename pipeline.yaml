resources:
- name: ${namespace}-repository
  type: git
  source:
    uri: ${source_code_url}.git
    branch: ${branch}
- name: tools-image
  type: docker-image
  source:
    repository: ministryofjustice/cloud-platform-tools
    tag: concourse

groups: 
- name: deploy
  jobs: [deploy-application]

jobs:

- name: deploy-application
  serial: true
  plan:
    - in_parallel:
      - get: ${namespace}-repository
        trigger: true
      - get: tools-image
    - task: ${namespace}
      image: tools-image
      config:
        platform: linux
        inputs:
          - name: ${namespace}-repository
        params:
          AWS_ACCESS_KEY_ID: ((concourse-s3-bucket.access_key_id))
          AWS_SECRET_ACCESS_KEY: ((concourse-s3-bucket.secret_access_key))
          KUBECONFIG: /tmp/kubeconfig
        run:
          path: /bin/bash
          dir: ${namespace}-repository
          args:
            - -c
            - |
              (
                AWS_ACCESS_KEY_ID="$${AWS_ACCESS_KEY_ID}"
                AWS_SECRET_ACCESS_KEY="$${AWS_SECRET_ACCESS_KEY}"
                aws s3 cp s3://cloud-platform-ebfa84b1529190aaeb23141df8473a85/gitops-config /tmp/kubeconfig
              )
              kubectl -n ${namespace} apply -f ./cloud-platform-deploy/${namespace}/. --as "system:serviceaccount:concourse-${github_team}:deploy"

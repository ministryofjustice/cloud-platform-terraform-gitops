resources:
- name: ${namespace}-repository
  type: git
  source:
    uri: ${source_code_url}.git
    branch: ${branch}
- name: gitops-repository
  type: git
  source:
    uri: https://github.com/ministryofjustice/cloud-platform-terraform-gitops
    branch: master
- name: tools-image
  type: docker-image
  source:
    repository: ministryofjustice/cloud-platform-tools
    tag: concourse

groups: 
- name: deploy
  jobs: [deploy-application]

jobs:

- name: deploy-application
  serial: true
  plan:
    - in_parallel:
      - get: ${namespace}-repository
        trigger: true
      - get: gitops-repository
        trigger: true
      - get: tools-image
    - task: ${namespace}
      image: tools-image
      config:
        platform: linux
        inputs:
          - name: ${namespace}-repository
        params:
          AWS_ACCESS_KEY_ID: ((aws-creds.access-key-id))
          AWS_SECRET_ACCESS_KEY: ((aws-creds.secret-access-key))
          KUBECONFIG: "/tmp/kubconfig"
        run:
          path: /bin/bash
          dir: ${namespace}-repository
          args:
            - -c
            - |
              sleep 300
              aws s3 cp s3://cloud-platform-concourse-kubeconfig/kubeconfig /tmp/kubeconfig
              kubectl --kubeconfig "$${KUBECONFIG}" -n concourse-${github_team} get secret ${github_team}-gpg-seckey -ojson | jq -r '.data.key | @base64d' | gpg --batch --import
              git-crypt unlock
              kubectl --kubeconfig "$${KUBECONFIG}" -n ${namespace} apply -f ./cloud-platform-deploy/${namespace}/. --as "system:serviceaccount:concourse-${github_team}:deploy"

